<div class="pdv-container">
  <!-- Header -->
  <div class="header">
    <h1>PDV - Ponto de Venda</h1>
    <p class="subtitle">Sistema de vendas rápido e eficiente</p>
  </div>

  <div class="pdv-content">
    <!-- Coluna Esquerda: Produtos -->
    <div class="products-section">
      <mat-card class="search-card">
        <mat-card-content>
          <mat-form-field class="full-width" appearance="outline">
            <mat-label>Buscar Produto</mat-label>
            <mat-icon matPrefix>search</mat-icon>
            <input matInput [(ngModel)]="searchProduct" placeholder="Digite o nome ou código">
          </mat-form-field>
        </mat-card-content>
      </mat-card>

      <mat-card class="products-list">
        <mat-card-header>
          <mat-card-title>Produtos Disponíveis</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="product-grid">
            @for (product of availableProducts; track product.id) {
              <button 
                mat-raised-button 
                class="product-btn"
                (click)="addProduct(product.id)">
                <div class="product-info">
                  <mat-icon>shopping_cart</mat-icon>
                  <span class="product-name">{{ product.name }}</span>
                  <span class="product-price">R$ {{ product.price.toFixed(2) }}</span>
                  <span class="product-stock">Estoque: {{ product.stock }}</span>
                </div>
              </button>
            }
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Coluna Direita: Carrinho e Pagamento -->
    <div class="cart-section">
      <!-- Carrinho -->
      <mat-card class="cart-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>shopping_basket</mat-icon>
            Carrinho de Compras
          </mat-card-title>
          <button mat-icon-button (click)="clearCart()" [disabled]="cart.length === 0">
            <mat-icon>delete_sweep</mat-icon>
          </button>
        </mat-card-header>
        <mat-card-content>
          @if (cart.length === 0) {
            <div class="empty-cart">
              <mat-icon>shopping_cart</mat-icon>
              <p>Carrinho vazio</p>
              <span>Adicione produtos para iniciar a venda</span>
            </div>
          } @else {
            <table mat-table [dataSource]="cart" class="cart-table">
              <!-- Nome -->
              <ng-container matColumnDef="name">
                <th mat-header-cell *matHeaderCellDef>Produto</th>
                <td mat-cell *matCellDef="let item">{{ item.name }}</td>
              </ng-container>

              <!-- Preço -->
              <ng-container matColumnDef="price">
                <th mat-header-cell *matHeaderCellDef>Preço</th>
                <td mat-cell *matCellDef="let item">R$ {{ item.price.toFixed(2) }}</td>
              </ng-container>

              <!-- Quantidade -->
              <ng-container matColumnDef="quantity">
                <th mat-header-cell *matHeaderCellDef>Qtd</th>
                <td mat-cell *matCellDef="let item">
                  <div class="quantity-control">
                    <button mat-icon-button (click)="updateQuantity(item, item.quantity - 1)">
                      <mat-icon>remove</mat-icon>
                    </button>
                    <span>{{ item.quantity }}</span>
                    <button mat-icon-button (click)="updateQuantity(item, item.quantity + 1)">
                      <mat-icon>add</mat-icon>
                    </button>
                  </div>
                </td>
              </ng-container>

              <!-- Subtotal -->
              <ng-container matColumnDef="subtotal">
                <th mat-header-cell *matHeaderCellDef>Subtotal</th>
                <td mat-cell *matCellDef="let item">R$ {{ item.subtotal.toFixed(2) }}</td>
              </ng-container>

              <!-- Ações -->
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef></th>
                <td mat-cell *matCellDef="let item">
                  <button mat-icon-button color="warn" (click)="removeItem(item)">
                    <mat-icon>delete</mat-icon>
                  </button>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            </table>
          }
        </mat-card-content>
      </mat-card>

      <!-- Totais e Pagamento -->
      <mat-card class="payment-card">
        <mat-card-content>
          <!-- Desconto -->
          <mat-form-field class="full-width" appearance="outline">
            <mat-label>Desconto (%)</mat-label>
            <mat-icon matPrefix>local_offer</mat-icon>
            <input matInput type="number" [(ngModel)]="discount" min="0" max="100">
          </mat-form-field>

          <mat-divider></mat-divider>

          <!-- Resumo -->
          <div class="totals">
            <div class="total-row">
              <span>Subtotal:</span>
              <span class="value">R$ {{ subtotal.toFixed(2) }}</span>
            </div>
            <div class="total-row discount-row">
              <span>Desconto ({{ discount }}%):</span>
              <span class="value">- R$ {{ discountAmount.toFixed(2) }}</span>
            </div>
            <mat-divider></mat-divider>
            <div class="total-row final-total">
              <span>TOTAL:</span>
              <span class="value">R$ {{ total.toFixed(2) }}</span>
            </div>
          </div>

          <!-- Pagamentos Realizados -->
          @if (payments.length > 0) {
            <div class="payments-list">
              <h3>Pagamentos:</h3>
              @for (payment of payments; track $index) {
                <div class="payment-item">
                  <div class="payment-info">
                    <mat-icon>{{ payment.method === 'money' ? 'payments' : payment.method === 'pix' ? 'pix' : 'credit_card' }}</mat-icon>
                    <div>
                      <strong>{{ getPaymentMethodLabel(payment.method) }}</strong>
                      @if (payment.installments && payment.installments > 1) {
                        <span class="installments">{{ payment.installments }}x de R$ {{ payment.installmentValue?.toFixed(2) }}</span>
                      }
                    </div>
                  </div>
                  <div class="payment-value">
                    <span>R$ {{ payment.amount.toFixed(2) }}</span>
                    <button mat-icon-button (click)="removePayment($index)" color="warn">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                </div>
              }
              
              <mat-divider></mat-divider>
              
              <div class="payment-summary">
                <div class="total-row">
                  <span>Total Pago:</span>
                  <span class="value paid">R$ {{ totalPaid.toFixed(2) }}</span>
                </div>
                <div class="total-row">
                  <span>Restante:</span>
                  <span class="value" [class.remaining]="remaining > 0">R$ {{ remaining.toFixed(2) }}</span>
                </div>
                @if (change > 0) {
                  <div class="total-row">
                    <span>Troco:</span>
                    <span class="value change">R$ {{ change.toFixed(2) }}</span>
                  </div>
                }
              </div>
            </div>
          }

          <!-- Botões -->
          <div class="action-buttons">
            <button 
              mat-raised-button 
              color="accent"
              (click)="openPaymentModal()"
              [disabled]="cart.length === 0 || remaining <= 0">
              <mat-icon>add_card</mat-icon>
              Adicionar Pagamento
            </button>
          </div>

          <div class="action-buttons">
            <button 
              mat-raised-button 
              color="warn" 
              (click)="clearCart()"
              [disabled]="cart.length === 0">
              <mat-icon>cancel</mat-icon>
              Cancelar
            </button>
            <button 
              mat-raised-button 
              color="primary" 
              (click)="finalizeSale()"
              [disabled]="cart.length === 0 || remaining > 0">
              <mat-icon>check_circle</mat-icon>
              Finalizar Venda
            </button>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>

<!-- Modal de Pagamento -->
@if (showPaymentModal) {
  <div class="payment-modal-overlay" (click)="closePaymentModal()">
    <div class="payment-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Adicionar Pagamento</h2>
        <button mat-icon-button (click)="closePaymentModal()">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="modal-content">
        <!-- Valor Restante -->
        <div class="remaining-alert">
          <mat-icon>info</mat-icon>
          <span>Valor restante: <strong>R$ {{ remaining.toFixed(2) }}</strong></span>
        </div>

        <!-- Forma de Pagamento -->
        <mat-form-field class="full-width" appearance="outline">
          <mat-label>Forma de Pagamento</mat-label>
          <mat-icon matPrefix>payment</mat-icon>
          <mat-select [(ngModel)]="currentPaymentMethod">
            <mat-option value="money">Dinheiro</mat-option>
            <mat-option value="debit">Cartão de Débito</mat-option>
            <mat-option value="credit">Cartão de Crédito</mat-option>
            <mat-option value="pix">PIX</mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Valor -->
        <mat-form-field class="full-width" appearance="outline">
          <mat-label>Valor</mat-label>
          <span matTextPrefix>R$&nbsp;</span>
          <input matInput type="number" [(ngModel)]="currentPaymentAmount" min="0" [max]="remaining" step="0.01">
        </mat-form-field>

        <!-- Parcelamento (apenas para crédito) -->
        @if (currentPaymentMethod === 'credit') {
          <mat-form-field class="full-width" appearance="outline">
            <mat-label>Parcelas</mat-label>
            <mat-icon matPrefix>credit_card</mat-icon>
            <mat-select [(ngModel)]="installments">
              <mat-option [value]="1">1x sem juros</mat-option>
              <mat-option [value]="2">2x sem juros</mat-option>
              <mat-option [value]="3">3x (taxa 2.5%)</mat-option>
              <mat-option [value]="4">4x (taxa 3.5%)</mat-option>
              <mat-option [value]="5">5x (taxa 4.5%)</mat-option>
              <mat-option [value]="6">6x (taxa 5.5%)</mat-option>
              <mat-option [value]="10">10x (taxa 8%)</mat-option>
              <mat-option [value]="12">12x (taxa 10%)</mat-option>
            </mat-select>
          </mat-form-field>

          @if (installments > 1) {
            <div class="installment-info">
              <p><strong>{{ installments }}x</strong> de <strong>R$ {{ installmentValue.toFixed(2) }}</strong></p>
              <p class="total-with-fee">Total com juros: R$ {{ totalWithInstallmentFee.toFixed(2) }}</p>
            </div>
          }
        }

        <!-- Dinheiro recebido (apenas para dinheiro) -->
        @if (currentPaymentMethod === 'money') {
          <mat-form-field class="full-width" appearance="outline">
            <mat-label>Dinheiro Recebido</mat-label>
            <span matTextPrefix>R$&nbsp;</span>
            <input matInput type="number" [(ngModel)]="cashReceived" min="0" step="0.01" (blur)="calculateChange()">
          </mat-form-field>

          @if (cashReceived > 0 && cashReceived >= currentPaymentAmount) {
            <div class="change-info">
              <mat-icon>check_circle</mat-icon>
              <span>Troco: <strong>R$ {{ (cashReceived - currentPaymentAmount).toFixed(2) }}</strong></span>
            </div>
          }
        }
      </div>

      <div class="modal-footer">
        <button mat-raised-button (click)="closePaymentModal()">
          Cancelar
        </button>
        <button mat-raised-button color="primary" (click)="addPayment()">
          <mat-icon>add</mat-icon>
          Adicionar
        </button>
      </div>
    </div>
  </div>
}
