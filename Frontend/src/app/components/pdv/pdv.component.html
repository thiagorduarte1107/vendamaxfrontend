<div class="pdv-container">
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <h1>PDV - Ponto de Venda</h1>
      <p class="subtitle">Sistema de vendas rápido e eficiente</p>
    </div>
    <div class="header-right">
      <!-- Status do Caixa -->
      <div class="cash-status" [class.open]="cashRegister.isOpen" [class.closed]="!cashRegister.isOpen">
        <mat-icon>{{ cashRegister.isOpen ? 'lock_open' : 'lock' }}</mat-icon>
        <div class="cash-info">
          <span class="cash-label">{{ cashRegister.isOpen ? 'Caixa Aberto' : 'Caixa Fechado' }}</span>
          <span class="cash-balance" *ngIf="cashRegister.isOpen">R$ {{ cashRegister.currentBalance.toFixed(2) }}</span>
        </div>
      </div>
      
      <!-- Botões de Controle -->
      <button mat-raised-button color="primary" *ngIf="!cashRegister.isOpen" (click)="showOpenCashDialog()">
        <mat-icon>lock_open</mat-icon>
        Abrir Caixa
      </button>
      <button mat-raised-button color="warn" *ngIf="cashRegister.isOpen" (click)="closeCashRegister()">
        <mat-icon>lock</mat-icon>
        Fechar Caixa
      </button>
      
      <!-- Botão Buscar Comandas -->
      <button mat-icon-button (click)="toggleComandaSearch()" matTooltip="Buscar Comandas (F6)" [color]="showComandaSearch ? 'accent' : ''">
        <mat-icon [matBadge]="availableComandas.length" matBadgeColor="warn" [matBadgeHidden]="availableComandas.length === 0">receipt_long</mat-icon>
      </button>
      
      <!-- Botão Histórico -->
      <button mat-icon-button (click)="toggleDailySales()" matTooltip="Histórico do Dia (F5)">
        <mat-icon [matBadge]="getTodaysSalesCount()" matBadgeColor="accent">history</mat-icon>
      </button>
      
      <!-- Botão Exportar PDF -->
      <button mat-icon-button (click)="exportDailySalesToPDF()" matTooltip="Exportar Relatório PDF" *ngIf="getTodaysSalesCount() > 0">
        <mat-icon>picture_as_pdf</mat-icon>
      </button>
      
      <!-- Botões Sangria/Suprimento -->
      <button mat-icon-button *ngIf="cashRegister.isOpen" (click)="openWithdrawalDialog()" matTooltip="Sangria (F8)">
        <mat-icon>remove_circle</mat-icon>
      </button>
      <button mat-icon-button *ngIf="cashRegister.isOpen" (click)="openDepositDialog()" matTooltip="Suprimento (F9)">
        <mat-icon>add_circle</mat-icon>
      </button>
    </div>
  </div>

  <!-- Atalhos de Teclado -->
  <div class="shortcuts-bar">
    <span class="shortcut"><kbd>F2</kbd> Finalizar</span>
    <span class="shortcut"><kbd>F3</kbd> Limpar</span>
    <span class="shortcut"><kbd>F4</kbd> Pagamento</span>
    <span class="shortcut"><kbd>F5</kbd> Histórico</span>
    <span class="shortcut"><kbd>F6</kbd> Comandas</span>
    <span class="shortcut"><kbd>F8</kbd> Sangria</span>
    <span class="shortcut"><kbd>F9</kbd> Suprimento</span>
  </div>

  <div class="pdv-content">
    <!-- Coluna Esquerda: Produtos -->
    <div class="products-section">
      <mat-card class="search-card">
        <mat-card-content>
          <mat-form-field class="full-width" appearance="outline">
            <mat-label>Buscar Produto</mat-label>
            <input matInput [(ngModel)]="searchProduct" 
                   (keypress)="onSearchProductKeyPress($event)"
                   placeholder="Digite o nome ou código e pressione Enter">
            <mat-hint>{{ filteredProducts.length }} produto(s) encontrado(s)</mat-hint>
          </mat-form-field>
        </mat-card-content>
      </mat-card>

      <!-- Logo do Lojista -->
      <mat-card class="store-logo-card">
        <mat-card-content class="logo-content">
          <div class="logo-container">
            @if (companyData?.logo) {
              <img [src]="companyData!.logo" alt="Logo da empresa" class="company-logo">
            } @else {
              <div class="logo-placeholder">
                <mat-icon>store</mat-icon>
                <p>Logo da Loja</p>
                <span>Adicione sua logo nas configurações</span>
              </div>
            }
          </div>
          
          <div class="store-info">
            <h2>{{ companyData?.tradeName || 'VendaMax' }}</h2>
            <p class="store-tagline">{{ companyData?.name || 'Sistema de Gestão Comercial' }}</p>
            <div class="store-details">
              @if (companyData?.phone) {
                <div class="detail-item">
                  <mat-icon>phone</mat-icon>
                  <span>{{ companyData!.phone }}</span>
                </div>
              }
              @if (companyData?.city && companyData?.state) {
                <div class="detail-item">
                  <mat-icon>location_on</mat-icon>
                  <span>{{ companyData!.city }}, {{ companyData!.state }}</span>
                </div>
              }
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Coluna Direita: Carrinho e Pagamento -->
    <div class="cart-section">
      <!-- Carrinho -->
      <mat-card class="cart-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>shopping_basket</mat-icon>
            Carrinho de Compras
          </mat-card-title>
          <button mat-icon-button (click)="clearCart()" [disabled]="cart.length === 0">
            <mat-icon>delete_sweep</mat-icon>
          </button>
        </mat-card-header>
        <mat-card-content>
          @if (cart.length === 0) {
            <div class="empty-cart">
              <mat-icon>shopping_cart</mat-icon>
              <p>Carrinho vazio</p>
              <span>Adicione produtos para iniciar a venda</span>
            </div>
          } @else {
            <table mat-table [dataSource]="cart" class="cart-table">
              <!-- Nome -->
              <ng-container matColumnDef="name">
                <th mat-header-cell *matHeaderCellDef>Produto</th>
                <td mat-cell *matCellDef="let item">{{ item.name }}</td>
              </ng-container>

              <!-- Preço -->
              <ng-container matColumnDef="price">
                <th mat-header-cell *matHeaderCellDef>Preço</th>
                <td mat-cell *matCellDef="let item">R$ {{ item.price.toFixed(2) }}</td>
              </ng-container>

              <!-- Quantidade -->
              <ng-container matColumnDef="quantity">
                <th mat-header-cell *matHeaderCellDef>Qtd</th>
                <td mat-cell *matCellDef="let item">
                  <div class="quantity-control">
                    <button mat-icon-button (click)="updateQuantity(item, item.quantity - 1)">
                      <mat-icon>remove</mat-icon>
                    </button>
                    <span>{{ item.quantity }}</span>
                    <button mat-icon-button (click)="updateQuantity(item, item.quantity + 1)">
                      <mat-icon>add</mat-icon>
                    </button>
                  </div>
                </td>
              </ng-container>

              <!-- Subtotal -->
              <ng-container matColumnDef="subtotal">
                <th mat-header-cell *matHeaderCellDef>Subtotal</th>
                <td mat-cell *matCellDef="let item">R$ {{ item.subtotal.toFixed(2) }}</td>
              </ng-container>

              <!-- Ações -->
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef></th>
                <td mat-cell *matCellDef="let item">
                  <button mat-icon-button color="warn" (click)="removeItem(item)">
                    <mat-icon>delete</mat-icon>
                  </button>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            </table>
          }
        </mat-card-content>
      </mat-card>

      <!-- Totais e Pagamento -->
      <mat-card class="payment-card">
        <mat-card-content>
          <!-- Desconto -->
          <mat-form-field class="full-width" appearance="outline">
            <mat-label>Desconto (%)</mat-label>
            <input matInput type="number" [(ngModel)]="discount" min="0" max="100">
          </mat-form-field>

          <mat-divider></mat-divider>

          <!-- Resumo -->
          <div class="totals">
            <div class="total-row">
              <span>Subtotal:</span>
              <span class="value">R$ {{ subtotal.toFixed(2) }}</span>
            </div>
            <div class="total-row discount-row">
              <span>Desconto ({{ discount }}%):</span>
              <span class="value">- R$ {{ discountAmount.toFixed(2) }}</span>
            </div>
            <mat-divider></mat-divider>
            <div class="total-row final-total">
              <span>TOTAL:</span>
              <span class="value">R$ {{ total.toFixed(2) }}</span>
            </div>
          </div>

          <!-- Pagamentos Realizados -->
          @if (payments.length > 0) {
            <div class="payments-list">
              <h3>Pagamentos:</h3>
              @for (payment of payments; track $index) {
                <div class="payment-item">
                  <div class="payment-info">
                    <mat-icon>{{ payment.method === 'money' ? 'payments' : payment.method === 'pix' ? 'pix' : 'credit_card' }}</mat-icon>
                    <div>
                      <strong>{{ getPaymentMethodLabel(payment.method) }}</strong>
                      @if (payment.installments && payment.installments > 1) {
                        <span class="installments">{{ payment.installments }}x de R$ {{ payment.installmentValue?.toFixed(2) }}</span>
                      }
                    </div>
                  </div>
                  <div class="payment-value">
                    <span>R$ {{ payment.amount.toFixed(2) }}</span>
                    <button mat-icon-button (click)="removePayment($index)" color="warn">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                </div>
              }
              
              <mat-divider></mat-divider>
              
              <div class="payment-summary">
                <div class="total-row">
                  <span>Total Pago:</span>
                  <span class="value paid">R$ {{ totalPaid.toFixed(2) }}</span>
                </div>
                <div class="total-row">
                  <span>Restante:</span>
                  <span class="value" [class.remaining]="remaining > 0">R$ {{ remaining.toFixed(2) }}</span>
                </div>
                @if (change > 0) {
                  <div class="total-row">
                    <span>Troco:</span>
                    <span class="value change">R$ {{ change.toFixed(2) }}</span>
                  </div>
                }
              </div>
            </div>
          }

          <!-- Botões -->
          <div class="action-buttons">
            <button 
              mat-raised-button 
              color="accent"
              (click)="openPaymentModal()"
              [disabled]="cart.length === 0 || remaining <= 0">
              <mat-icon>add_card</mat-icon>
              Adicionar Pagamento
            </button>
          </div>

          <div class="action-buttons">
            <button 
              mat-raised-button 
              color="warn" 
              (click)="clearCart()"
              [disabled]="cart.length === 0">
              <mat-icon>cancel</mat-icon>
              Cancelar
            </button>
            <button 
              mat-raised-button 
              color="primary" 
              (click)="finalizeSale()"
              [disabled]="cart.length === 0 || remaining > 0">
              <mat-icon>check_circle</mat-icon>
              Finalizar Venda
            </button>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>

<!-- Modal de Pagamento -->
@if (showPaymentModal) {
  <div class="payment-modal-overlay" (click)="closePaymentModal()">
    <div class="payment-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Adicionar Pagamento</h2>
        <button mat-icon-button (click)="closePaymentModal()">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="modal-content">
        <!-- Valor Restante -->
        <div class="remaining-alert">
          <mat-icon>info</mat-icon>
          <span>Valor restante: <strong>R$ {{ remaining.toFixed(2) }}</strong></span>
        </div>

        <!-- Forma de Pagamento -->
        <mat-form-field class="full-width" appearance="outline">
          <mat-label>Forma de Pagamento</mat-label>
          <mat-select [(ngModel)]="currentPaymentMethod">
            <mat-option value="money">Dinheiro</mat-option>
            <mat-option value="debit">Cartão de Débito</mat-option>
            <mat-option value="credit">Cartão de Crédito</mat-option>
            <mat-option value="pix">PIX</mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Valor -->
        <mat-form-field class="full-width" appearance="outline">
          <mat-label>Valor</mat-label>
          <span matTextPrefix>R$&nbsp;</span>
          <input matInput type="number" [(ngModel)]="currentPaymentAmount" min="0" [max]="remaining" step="0.01">
        </mat-form-field>

        <!-- Parcelamento (apenas para crédito) -->
        @if (currentPaymentMethod === 'credit') {
          <mat-form-field class="full-width" appearance="outline">
            <mat-label>Parcelas</mat-label>
            <mat-select [(ngModel)]="installments">
              <mat-option [value]="1">1x sem juros</mat-option>
              <mat-option [value]="2">2x sem juros</mat-option>
              <mat-option [value]="3">3x (taxa 2.5%)</mat-option>
              <mat-option [value]="4">4x (taxa 3.5%)</mat-option>
              <mat-option [value]="5">5x (taxa 4.5%)</mat-option>
              <mat-option [value]="6">6x (taxa 5.5%)</mat-option>
              <mat-option [value]="10">10x (taxa 8%)</mat-option>
              <mat-option [value]="12">12x (taxa 10%)</mat-option>
            </mat-select>
          </mat-form-field>

          @if (installments > 1) {
            <div class="installment-info">
              <p><strong>{{ installments }}x</strong> de <strong>R$ {{ installmentValue.toFixed(2) }}</strong></p>
              <p class="total-with-fee">Total com juros: R$ {{ totalWithInstallmentFee.toFixed(2) }}</p>
            </div>
          }
        }

        <!-- Dinheiro recebido (apenas para dinheiro) -->
        @if (currentPaymentMethod === 'money') {
          <mat-form-field class="full-width" appearance="outline">
            <mat-label>Dinheiro Recebido</mat-label>
            <span matTextPrefix>R$&nbsp;</span>
            <input matInput type="number" [(ngModel)]="cashReceived" min="0" step="0.01" (blur)="calculateChange()">
          </mat-form-field>

          @if (cashReceived > 0 && cashReceived >= currentPaymentAmount) {
            <div class="change-info">
              <mat-icon>check_circle</mat-icon>
              <span>Troco: <strong>R$ {{ (cashReceived - currentPaymentAmount).toFixed(2) }}</strong></span>
            </div>
          }
        }
      </div>

      <div class="modal-footer">
        <button mat-raised-button (click)="closePaymentModal()">
          Cancelar
        </button>
        <button mat-raised-button color="primary" (click)="addPayment()">
          <mat-icon>add</mat-icon>
          Adicionar
        </button>
      </div>
    </div>
  </div>
}

<!-- Modal de Busca de Comandas -->
@if (showComandaSearch) {
  <div class="payment-modal-overlay" (click)="toggleComandaSearch()">
    <div class="payment-modal comanda-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>
          <mat-icon>receipt_long</mat-icon>
          Buscar Comandas
        </h2>
        <button mat-icon-button (click)="toggleComandaSearch()">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="modal-content">
        <!-- Busca -->
        <mat-form-field class="full-width" appearance="outline">
          <mat-label>Buscar por número, cliente, mesa ou vendedor</mat-label>
          <input matInput [(ngModel)]="comandaSearch" (ngModelChange)="searchComandas()" placeholder="Digite para buscar...">
        </mat-form-field>

        <!-- Lista de Comandas -->
        <div class="comandas-list">
          @if (filteredComandas.length === 0) {
            <div class="no-comandas-message">
              <mat-icon>receipt_long</mat-icon>
              <p>Nenhuma comanda fechada encontrada</p>
            </div>
          }

          @for (comanda of filteredComandas; track comanda.id) {
            <mat-card class="comanda-item" (click)="loadComandaToCart(comanda)">
              <div class="comanda-header-item">
                <div class="comanda-number">
                  <mat-icon>receipt_long</mat-icon>
                  <strong>{{ comanda.number }}</strong>
                </div>
                <mat-chip color="accent" selected>
                  R$ {{ comanda.subtotal.toFixed(2) }}
                </mat-chip>
              </div>

              <div class="comanda-details">
                <div class="detail-row">
                  <mat-icon>person</mat-icon>
                  <span>Vendedor: <strong>{{ comanda.sellerName }}</strong></span>
                </div>

                @if (comanda.customerName) {
                  <div class="detail-row">
                    <mat-icon>account_circle</mat-icon>
                    <span>Cliente: <strong>{{ comanda.customerName }}</strong></span>
                  </div>
                }

                @if (comanda.table) {
                  <div class="detail-row">
                    <mat-icon>table_restaurant</mat-icon>
                    <span>Mesa: <strong>{{ comanda.table }}</strong></span>
                  </div>
                }

                <div class="detail-row">
                  <mat-icon>shopping_basket</mat-icon>
                  <span>{{ comanda.items.length }} {{ comanda.items.length === 1 ? 'item' : 'itens' }}</span>
                </div>

                <div class="detail-row">
                  <mat-icon>schedule</mat-icon>
                  <span>{{ comanda.closedAt | date:'dd/MM/yyyy HH:mm' }}</span>
                </div>
              </div>

              <div class="comanda-action">
                <mat-icon>arrow_forward</mat-icon>
                <span>Clique para carregar</span>
              </div>
            </mat-card>
          }
        </div>
      </div>
    </div>
  </div>
}
