<div class="dashboard-container">
  <div class="header">
    <div>
      <h1>Dashboard</h1>
      <p class="subtitle">Visão geral do seu negócio - {{ getPeriodLabel() }}</p>
    </div>
    <div class="header-actions">
      <button mat-icon-button [matMenuTriggerFor]="periodMenu" matTooltip="Filtrar Período">
        <mat-icon>date_range</mat-icon>
      </button>
      <mat-menu #periodMenu="matMenu">
        <button mat-menu-item (click)="applyPeriodFilter('today')">
          <mat-icon>today</mat-icon>
          <span>Hoje</span>
        </button>
        <button mat-menu-item (click)="applyPeriodFilter('week')">
          <mat-icon>view_week</mat-icon>
          <span>Esta Semana</span>
        </button>
        <button mat-menu-item (click)="applyPeriodFilter('month')">
          <mat-icon>calendar_month</mat-icon>
          <span>Este Mês</span>
        </button>
        <button mat-menu-item (click)="applyPeriodFilter('quarter')">
          <mat-icon>calendar_view_month</mat-icon>
          <span>Este Trimestre</span>
        </button>
        <button mat-menu-item (click)="applyPeriodFilter('year')">
          <mat-icon>calendar_today</mat-icon>
          <span>Este Ano</span>
        </button>
      </mat-menu>

      <button mat-icon-button (click)="toggleComparison()" matTooltip="Comparar Períodos">
        <mat-icon>compare_arrows</mat-icon>
      </button>

      <button mat-icon-button (click)="exportDashboardAsPDF()" matTooltip="Exportar PDF">
        <mat-icon>picture_as_pdf</mat-icon>
      </button>
    </div>
  </div>

  <div *ngIf="loading" class="loading-container">
    <mat-spinner></mat-spinner>
  </div>

  <div *ngIf="!loading && metrics" class="dashboard-content">
    <!-- Métricas Cards -->
    <div class="metrics-grid">
      <mat-card class="metric-card">
        <mat-card-content>
          <div class="metric-icon sales">
            <mat-icon>shopping_cart</mat-icon>
          </div>
          <div class="metric-info">
            <h3>Vendas Totais</h3>
            <p class="metric-value">{{ metrics.totalSales }}</p>
            <div class="metric-trend up">
              <mat-icon>trending_up</mat-icon>
              <span>+12.5% em relação ao mês anterior</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="metric-card">
        <mat-card-content>
          <div class="metric-icon revenue">
            <mat-icon>attach_money</mat-icon>
          </div>
          <div class="metric-info">
            <h3>Faturamento</h3>
            <p class="metric-value">{{ formatCurrency(metrics.totalRevenue) }}</p>
            <div class="metric-trend up">
              <mat-icon>trending_up</mat-icon>
              <span>+8.2% em relação ao mês anterior</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="metric-card">
        <mat-card-content>
          <div class="metric-icon expenses">
            <mat-icon>receipt</mat-icon>
          </div>
          <div class="metric-info">
            <h3>Despesas</h3>
            <p class="metric-value">{{ formatCurrency(metrics.totalExpenses) }}</p>
            <div class="metric-trend down">
              <mat-icon>trending_down</mat-icon>
              <span>-3.1% em relação ao mês anterior</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="metric-card">
        <mat-card-content>
          <div class="metric-icon credit">
            <mat-icon>account_balance_wallet</mat-icon>
          </div>
          <div class="metric-info">
            <h3>Créditos a Receber</h3>
            <p class="metric-value">{{ formatCurrency(metrics.totalCredit) }}</p>
            <div class="metric-trend up">
              <mat-icon>trending_up</mat-icon>
              <span>+5.4% em relação ao mês anterior</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Margem de Lucro -->
      <mat-card class="metric-card">
        <mat-card-content>
          <div class="metric-icon profit">
            <mat-icon>trending_up</mat-icon>
          </div>
          <div class="metric-info">
            <h3>Margem de Lucro</h3>
            <p class="metric-value">{{ getProfitMargin().toFixed(1) }}%</p>
            <div class="metric-trend" [class.up]="getProfitMargin() > 0" [class.down]="getProfitMargin() < 0">
              <mat-icon>{{ getProfitMargin() > 0 ? 'trending_up' : 'trending_down' }}</mat-icon>
              <span>{{ getProfitMargin() > 0 ? 'Positiva' : 'Negativa' }}</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- ROI -->
      <mat-card class="metric-card">
        <mat-card-content>
          <div class="metric-icon roi">
            <mat-icon>analytics</mat-icon>
          </div>
          <div class="metric-info">
            <h3>ROI</h3>
            <p class="metric-value">{{ getROI().toFixed(1) }}%</p>
            <div class="metric-trend" [class.up]="getROI() > 0" [class.down]="getROI() < 0">
              <mat-icon>{{ getROI() > 0 ? 'trending_up' : 'trending_down' }}</mat-icon>
              <span>Retorno sobre Investimento</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Gráficos -->
    <div class="charts-grid">
      <!-- Gráfico de Vendas -->
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>show_chart</mat-icon>
            Vendas por Período
          </mat-card-title>
          <mat-card-subtitle>Últimos 6 meses</mat-card-subtitle>
          <button mat-icon-button (click)="exportChartAsPNG('salesChart')" matTooltip="Exportar PNG">
            <mat-icon>download</mat-icon>
          </button>
        </mat-card-header>
        <mat-card-content>
          <div id="salesChart" class="chart-container">
            <canvas baseChart
              [data]="salesChartData"
              [options]="salesChartOptions"
              [type]="salesChartType">
            </canvas>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Gráfico de Produtos -->
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>bar_chart</mat-icon>
            Produtos Mais Vendidos
          </mat-card-title>
          <mat-card-subtitle>Top 5 produtos</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container">
            <canvas baseChart
              [data]="productsChartData"
              [options]="productsChartOptions"
              [type]="productsChartType">
            </canvas>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Gráfico de Pagamentos -->
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>pie_chart</mat-icon>
            Formas de Pagamento
          </mat-card-title>
          <mat-card-subtitle>Distribuição</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container">
            <canvas baseChart
              [data]="paymentChartData"
              [options]="paymentChartOptions"
              [type]="paymentChartType">
            </canvas>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Alerta de Estoque -->
    <mat-card class="alert-card" *ngIf="metrics.lowStockProducts > 0">
      <mat-card-content>
        <div class="alert-header">
          <div class="alert-icon-container">
            <mat-icon class="alert-icon">warning</mat-icon>
          </div>
          <div class="alert-info">
            <h3 class="alert-title">Alerta de Estoque</h3>
            <p class="alert-subtitle">Produtos com estoque baixo que precisam de atenção</p>
          </div>
        </div>
        <div class="alert-body">
          <div class="alert-stats">
            <div class="alert-stat-item">
              <span class="alert-stat-value">{{ metrics.lowStockProducts }}</span>
              <span class="alert-stat-label">Produtos</span>
            </div>
            <div class="alert-stat-divider"></div>
            <div class="alert-stat-item">
              <mat-chip class="alert-badge">
                <mat-icon>priority_high</mat-icon>
                Requer reposição
              </mat-chip>
            </div>
          </div>
          <button mat-raised-button color="warn" class="alert-button" routerLink="/products">
            <mat-icon>visibility</mat-icon>
            Ver Produtos
          </button>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Produtos com Estoque Baixo -->
    <mat-card class="low-stock-card" *ngIf="lowStockProducts.length > 0">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>inventory_2</mat-icon>
          Produtos com Estoque Baixo
        </mat-card-title>
        <mat-card-subtitle>{{ lowStockProducts.length }} produto(s) precisam de reposição</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="low-stock-list">
          <div class="low-stock-item" *ngFor="let product of lowStockProducts">
            <div class="product-icon-wrapper">
              <mat-icon class="product-icon">inventory_2</mat-icon>
            </div>
            <div class="product-details">
              <div class="product-name">{{ product.name }}</div>
              <div class="product-category" *ngIf="product.category">{{ product.category.name }}</div>
            </div>
            <div class="stock-info">
              <div class="stock-bar-container">
                <div class="stock-bar" [style.width.%]="(product.stock / product.minStock) * 100"></div>
              </div>
              <div class="stock-numbers">
                <span class="current-stock">{{ product.stock }}</span>
                <span class="stock-separator">/</span>
                <span class="min-stock">{{ product.minStock }}</span>
              </div>
            </div>
            <button mat-icon-button color="primary" routerLink="/stock-control" matTooltip="Adicionar Estoque">
              <mat-icon>add_circle</mat-icon>
            </button>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Ações Rápidas -->
    <mat-card class="quick-actions-card">
      <mat-card-header>
        <mat-card-title>Ações Rápidas</mat-card-title>
        <mat-card-subtitle>Ações mais comuns do dia a dia</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="quick-actions-grid">
          <button mat-stroked-button class="quick-action-btn" routerLink="/sales">
            <mat-icon>shopping_cart</mat-icon>
            <span>Nova Venda</span>
          </button>
          <button mat-stroked-button class="quick-action-btn" routerLink="/products">
            <mat-icon>inventory_2</mat-icon>
            <span>Novo Produto</span>
          </button>
          <button mat-stroked-button class="quick-action-btn" routerLink="/clients">
            <mat-icon>person_add</mat-icon>
            <span>Novo Cliente</span>
          </button>
          <button mat-stroked-button class="quick-action-btn" routerLink="/accounts-receivable">
            <mat-icon>trending_up</mat-icon>
            <span>Contas a Receber</span>
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>
